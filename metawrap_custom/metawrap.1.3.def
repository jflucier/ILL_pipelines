# build new image using this command: singularity build --force --fakeroot concoct.1.1.0.sif concoct.1.1.0.def

BootStrap: docker
From: ubuntu:20.04

%setup

%environment
    export PATH=/metaWRAP/bin:${PATH}
    # export DEBIAN_FRONTEND=noninteractive
    # export TZ=America/New_York
%post
    apt-get update && apt-get -y upgrade

    ln -fs /usr/share/zoneinfo/America/New_York /etc/localtime

    apt-get -y install \
    build-essential \
    wget \
    bzip2 \
    ca-certificates \
    libglib2.0-0 \
    libxext6 \
    libsm6 \
    libxrender1 \
    git \
    tzdata

    rm -rf /var/lib/apt/lists/*
    apt-get clean

    cd /
    #Installing Anaconda 3 https://repo.anaconda.com/miniconda/Miniconda3-py39_4.11.0-Linux-x86_64.sh
    wget -c https://repo.anaconda.com/miniconda/Miniconda3-py39_4.11.0-Linux-x86_64.sh
    /bin/bash Miniconda3-py39_4.11.0-Linux-x86_64.sh -bfp /usr/local
    #Conda configuration of channels from .condarc file
    conda config --file /.condarc --add channels defaults
    conda config --file /.condarc --add channels conda-forge
    conda update conda
    conda init bash
    . /usr/local/etc/profile.d/conda.sh

    conda install -y conda-build -n base
    conda install -y mamba -n base -c conda-forge

    # intall metawrap
    cd /

    git clone https://github.com/bxlab/metaWRAP.git
    conda create -y -n metawrap-env python=2.7
    conda activate metawrap-env

    conda config --file /.condarc --add channels bioconda
    conda config --file /.condarc --add channels ursky

    cd /metaWRAP
    conda-build .
    # mamba install -y -c bioconda bcftools
    # mamba install -c conda-forge boost
    # mamba install -y -c bioconda blast

    # mamba install --only-deps -c ursky metawrap-mg==1.3.0--hdfd78af_0
